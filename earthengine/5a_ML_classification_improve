/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var nonCropPoints2 = 
    /* color: #ff0000 */
    /* shown: false */
    ee.Geometry.MultiPoint(
        [[-16.352342783946238, 16.293067845735298],
         [-16.33757990552827, 16.30558976245004],
         [-16.34650629712983, 16.320746801089502],
         [-16.339983164805613, 16.323053204075304],
         [-16.33483332349702, 16.33787943105022],
         [-16.323503672618113, 16.35501055939156],
         [-16.312174021739207, 16.367199100970428],
         [-16.306680857676707, 16.382021976618667],
         [-16.308397471446238, 16.40474819626541],
         [-16.29706782056733, 16.369504955626812],
         [-15.27544060280535, 16.53323045838494],
         [-15.275279670264457, 16.53260305707105],
         [-15.257857075761773, 16.566519718150357],
         [-15.261161557268121, 16.567404094978922],
         [-15.264895192216851, 16.567424661833588],
         [-15.26641868693731, 16.566601985933627],
         [-15.255754223894098, 16.56557363611722],
         [-15.256269208024957, 16.564730385170975],
         [-15.320796715791683, 16.56877563838477],
         [-15.322427498872738, 16.56758276555102],
         [-15.326289879854183, 16.56750049818669],
         [-15.324337231691342, 16.568899038601042],
         [-15.8000219582861, 16.256256546860666],
         [-15.79954988949948, 16.25876970385011],
         [-15.802425217563444, 16.259058096858304],
         [-15.801953148776823, 16.261365225682717],
         [-15.80427057736569, 16.263589931385642],
         [-15.803400259708328, 16.26821674124459],
         [-15.801039915775222, 16.271842048150315],
         [-15.799065809940261, 16.274602180106044],
         [-15.78484211579926, 16.317482636352462],
         [-15.79205189363129, 16.300183459245407],
         [-15.777279088954828, 16.328627259804442],
         [-15.772074817352761, 16.33573408791098],
         [-15.769585727386941, 16.33960523788711],
         [-15.814979291405331, 16.182611003769498],
         [-15.813884950127255, 16.18211642355875],
         [-15.814872003044735, 16.179684719503435],
         [-15.813048100914608, 16.180632675493317],
         [-15.511045186900898, 15.953820965223288],
         [-15.014415352612422, 16.02349571824156],
         [-14.907298653393672, 16.0604505206079],
         [-14.797435372143672, 16.02613557420095],
         [-14.709544747143672, 16.081564471171333],
         [-14.838634102612422, 16.181825062975353],
         [-14.629893868237422, 16.142254576676493],
         [-14.833140938549922, 16.15544561868188],
         [-14.322749256189153, 16.172476209470002],
         [-14.341975330407903, 16.192259417374306],
         [-14.368067859704778, 16.186324663154167],
         [-14.287730335290716, 16.117732351248172],
         [-14.240351795251653, 16.119051658312546],
         [-14.177180408532903, 16.1342230583833],
         [-14.203272937829778, 16.158626785013553],
         [-14.116755603845403, 16.15796726440921],
         [-14.185420154626653, 16.06693236033374],
         [-14.178553699548528, 16.024699115290428],
         [-14.079676746423528, 16.02601903967451],
         [-13.884217032186372, 16.038260256480513],
         [-13.983093985311372, 15.988100070637655],
         [-14.046265372030122, 15.993380683467809],
         [-14.068638835151575, 15.808283905652615],
         [-14.077565226753137, 15.842636120086038],
         [-14.14416984101095, 15.95820154289987],
         [-14.07275870819845, 15.788462666649158],
         [-14.095418009956262, 15.760048843130413],
         [-14.23206046601095, 15.941696265284394],
         [-14.301411662300012, 15.917926279642137],
         [-14.332997355659387, 15.872359281705183],
         [-14.357716593940637, 15.877642940607757],
         [-14.39136222382345, 15.841975555650158],
         [-14.510838542182825, 15.818854439509394],
         [-14.523884806831262, 15.832066829831177],
         [-14.205281291206262, 15.667632321993318],
         [-14.243733439643762, 15.6577150889634],
         [-14.290425334175012, 15.645813774221295],
         [-14.3281908371047, 15.635895483002363],
         [-14.400288615425012, 15.61936392986882],
         [-15.568666391809984, 15.9408347227021],
         [-15.600252085169359, 15.963281663990085],
         [-15.611925058802171, 15.975824447604243],
         [-15.535707407434984, 16.010148044831364],
         [-15.560426645716234, 16.00486787508445],
         [-15.489015512903734, 16.016748060669258],
         [-15.469102793177171, 15.964601994001224],
         [-15.539018172970268, 16.316652248331906],
         [-15.504342574825737, 16.34465731650334],
         [-15.50949241613433, 16.369364337746834],
         [-15.5517211148648, 16.354869931067046],
         [-15.570260543575737, 16.300835850634257],
         [-15.592233199825737, 16.337738790392788],
         [-15.6286254117398, 16.32686632602841],
         [-15.647164840450737, 16.34663399325469],
         [-15.629312057247612, 16.351575597621842],
         [-15.619699020138237, 16.355199361354586],
         [-16.095556259404503, 16.067055234932184],
         [-16.111139696914805, 16.06703281978611],
         [-16.161264818985117, 16.075280450586273],
         [-16.149591845352305, 16.090785070211233],
         [-16.132082384903086, 16.10101085917433],
         [-16.148905199844492, 16.10628847964853],
         [-16.33271139341997, 16.017431538237727],
         [-16.331595594469775, 16.019906479441143],
         [-16.326831991259326, 16.022298893427223],
         [-16.326660329882372, 16.02452628755815],
         [-16.328419858996142, 16.023701329668473],
         [-16.32411455512855, 16.011411734660236],
         [-16.32407163978431, 16.011122980813237],
         [-16.324490064390634, 16.01042171973204],
         [-16.3280564707098, 16.009520253636303],
         [-16.328153030234336, 16.00911805685391],
         [-16.32583560164547, 16.008323973648643],
         [-16.321332887344838, 16.00776166712035],
         [-16.321633294754506, 16.007452282327495],
         [-16.32151527755785, 16.006998517097692],
         [-16.322159007721424, 16.00685413703565],
         [-16.319820121460438, 16.008380435268172],
         [-16.320195630722523, 16.00835980969413],
         [-16.31784906517187, 16.007999699316393],
         [-16.317419911729488, 16.008123452951843],
         [-16.31835332046667, 16.00640120796636],
         [-16.319179440843257, 16.006545588355838],
         [-16.321518327104243, 16.006153698484464],
         [-16.3220869554154, 16.00583399828306],
         [-16.337739758151667, 16.008698081707102],
         [-16.336838535922663, 16.00875995831802],
         [-16.337568096774714, 16.009976861103034],
         [-16.336323551791804, 16.009976861103034],
         [-16.336581043857233, 16.01073999974396],
         [-16.335529617923395, 16.011461884963094],
         [-16.336066059726374, 16.011895014841787],
         [-16.33495026077618, 16.012596270748492],
         [-16.335315041202204, 16.013194398840124],
         [-16.402740632525227, 16.005755515198313],
         [-16.404028092852375, 16.004497334748233],
         [-16.40587345265462, 16.003548537692023],
         [-16.403187900911654, 16.002116339761574],
         [-16.402651459108675, 16.00296201298403],
         [-16.351845357476282, 16.02069215844934],
         [-16.352338883935023, 16.020857152788604],
         [-16.352596376000452, 16.020970586317713],
         [-16.333657127668644, 16.308399749782847],
         [-16.334858757307316, 16.309882534065657],
         [-16.330567222883488, 16.284014576316824],
         [-16.32730565672138, 16.288133906396713],
         [-16.332112175276066, 16.312518567287967],
         [-16.336918693830754, 16.31548406223854],
         [-15.11823310697666, 16.55587285514901],
         [-15.116344831830176, 16.556448760717664],
         [-15.12050762022129, 16.556942392692548],
         [-15.119863890057715, 16.558670094647578],
         [-15.12600078428379, 16.561631833389306],
         [-15.125099562054785, 16.561549563483435],
         [-15.128146551495703, 16.559945293297737],
         [-15.13072147215, 16.560562321872993],
         [-15.132781408673438, 16.561261618536275],
         [-15.093697329621822, 16.557431057986648],
         [-15.092839022737056, 16.55796582317665],
         [-15.094298144441158, 16.558953078090312],
         [-15.09549977407983, 16.558541722490954],
         [-15.096529742341549, 16.557389922141343],
         [-15.097087641816646, 16.556649475424294],
         [-15.102974032870415, 16.54797594617545],
         [-15.104132747164849, 16.547605705092927],
         [-15.106321429721001, 16.547605705092927],
         [-15.107952212802056, 16.547194325278635],
         [-15.105063635982978, 16.543792539240638],
         [-15.105578620113837, 16.54268178976786],
         [-15.106823165096747, 16.541694451533736],
         [-15.1069948264737, 16.540748247650846],
         [-15.114848334469306, 16.542270399451112],
         [-15.088985460597668, 16.54346113984596],
         [-15.091131227809582, 16.542473805600835],
         [-15.088498061683199, 16.537376535244004],
         [-15.08772558548691, 16.53688285318373],
         [-15.086051887061616, 16.536101187338634],
         [-15.084378188636324, 16.535154956026837],
         [-15.08373445847275, 16.53470240897686],
         [-15.07845587113144, 16.538405035479574],
         [-15.077511733558199, 16.537993636043197],
         [-15.081073707129976, 16.539598088884713],
         [-15.060974882689974, 16.53320749230932],
         [-15.061232374755404, 16.53534681285834],
         [-15.059901999084017, 16.538720308616945],
         [-15.05582504138138, 16.53744496959288],
         [-15.052563475219271, 16.53468856290738],
         [-15.054408835021517, 16.534853125605594],
         [-15.054966734496615, 16.535099969389837],
         [-15.057155417052767, 16.532384670399633],
         [-15.057155417052767, 16.533783465559058],
         [-15.052520559875033, 16.53263151734083],
         [-15.053464697448275, 16.532837222884023],
         [-15.045782850829623, 16.529875041912614],
         [-15.045997427550814, 16.534153733169124],
         [-15.06934337481644, 16.530163033724005],
         [-15.068699644652865, 16.530985865103563],
         [-15.070158766356966, 16.53119157240045],
         [-15.066425131408236, 16.528764212330117],
         [-15.024673112419805, 16.550422613536213],
         [-15.029737123039922, 16.559472615139924],
         [-15.027505525139532, 16.558320820354258],
         [-14.986478456047735, 16.550587162812295],
         [-14.986735948113164, 16.55445403036934],
         [-16.448606635462962, 15.90846095406494],
         [-16.44912161959382, 15.905241733917268],
         [-16.43289961947175, 15.899876252470607],
         [-16.43118300570222, 15.903838467978508],
         [-16.42697730196687, 15.905654457329636],
         [-16.426118995082103, 15.907883149116264],
         [-16.455136305033108, 15.899728611315913],
         [-16.456016069589992, 15.900141346043014],
         [-16.44960022562637, 15.901090632701179],
         [-16.44807673090591, 15.901689093726445],
         [-16.446832185923, 15.903195556699474],
         [-15.330627932336377, 16.455565036428535],
         [-15.328138842370556, 16.457540587295846],
         [-15.326164736535596, 16.45762290147865],
         [-15.325392260339306, 16.4609977528938],
         [-15.335348620202588, 16.461656253638985],
         [-15.344875826623486, 16.46420792290356],
         [-15.27784205892329, 16.45062607124061],
         [-15.282734408166455, 16.45062607124061],
         [-15.270031466271924, 16.4603392499124],
         [-15.261535578788855, 16.47401436923735],
         [-15.256729060234168, 16.476812794011096],
         [-15.248660975517371, 16.478541212646963],
         [-15.24694436174784, 16.47788276927089],
         [-15.240335398735144, 16.47911734876492],
         [-15.236558848442176, 16.48347946661592],
         [-15.233297282280066, 16.488499895713215],
         [-15.165171666084396, 16.436645135222616],
         [-15.168519062934982, 16.4428192667806],
         [-15.165772480903732, 16.44631785417769],
         [-15.17130856031047, 16.445206545014592],
         [-15.183711094795333, 16.440184994660907],
         [-15.183711094795333, 16.437550686802275],
         [-15.157617723215735, 16.458500237965456],
         [-15.16023555921427, 16.46245125978014],
         [-15.163196717966711, 16.463233223304304],
         [-14.932057667924155, 16.388538937728338],
         [-14.941499043656577, 16.388044876553234],
         [-14.930512715531577, 16.395126300324193],
         [-14.945103932572593, 16.39874925477799],
         [-14.950940419389, 16.400396029970953],
         [-14.901801073357944, 16.383077777132954],
         [-14.899226152703648, 16.379619225675388],
         [-14.876223528191929, 16.406297889696877],
         [-14.8122381582178, 16.393455544029393],
         [-14.815070570937527, 16.39222041991736],
         [-14.819447936049832, 16.393043836862365],
         [-14.817216338149441, 16.397490228205534],
         [-14.841763915053738, 16.38958546230123],
         [-14.839360655776394, 16.38958546230123],
         [-14.820048750869168, 16.38991483395247],
         [-14.685558087977832, 16.303797642421976],
         [-14.68736053243584, 16.306021866901176],
         [-14.688819654139941, 16.304127158753328],
         [-14.709247357997363, 16.308740329184964],
         [-14.701007611903613, 16.288745740250125],
         [-14.717143781337207, 16.287015637553633],
         [-14.587855179758625, 16.147253155720534],
         [-14.58746894166048, 16.1487371543616],
         [-14.586267312021809, 16.149561593242105],
         [-14.590515931101399, 16.149726480605985],
         [-14.59373458191927, 16.151086796114917],
         [-14.595622857065754, 16.1506745802817],
         [-14.596309502573567, 16.152803521787682],
         [-14.59871276185091, 16.154988232404968],
         [-14.587004552670779, 16.14534991717791],
         [-14.582884679623904, 16.14559725343621],
         [-14.580309758969607, 16.145267471689795],
         [-14.671334668175842, 16.12936110761535],
         [-14.677171154992248, 16.130639111478985],
         [-14.674682065026428, 16.130968917589364],
         [-14.675712033288146, 16.13331877023239],
         [-14.675154133813049, 16.135256347055787],
         [-14.687985821740295, 16.128907620391775],
         [-14.687299176232482, 16.121280634312143],
         [-14.682750149743224, 16.121857821902356],
         [-14.68184892751422, 16.124125328307024],
         [-14.66764394857135, 16.12276482757706],
         [-14.692234440819885, 16.12297096465159]]),
    cropPoints2 = 
    /* color: #2bff00 */
    /* shown: false */
    ee.Geometry.MultiPoint(
        [[-16.132807654240054, 16.357922584114494],
         [-16.13366596112482, 16.36171093961462],
         [-16.15932933697931, 16.348533734065878],
         [-16.16087428937189, 16.350180933392306],
         [-16.157956045963687, 16.350345652560872],
         [-16.164565008976382, 16.365581574715655],
         [-16.16336337933771, 16.365581574715655],
         [-16.16336337933771, 16.3620403583569],
         [-16.163964194157046, 16.356604878010028],
         [-16.17881290326349, 16.363852151499607],
         [-16.177267950870913, 16.366322751401345],
         [-16.17160312543146, 16.366816867627538],
         [-16.18758092702595, 16.352971850524895],
         [-16.188439233910717, 16.35099523791369],
         [-16.189297540795483, 16.349512765326075],
         [-16.190756662499584, 16.348112641994394],
         [-16.16739481444993, 16.335578187371738],
         [-16.16464823241868, 16.343567504200507],
         [-16.25490149452144, 16.306073714216005],
         [-16.248120870131793, 16.308297912847944],
         [-16.23773535682613, 16.30969832124899],
         [-16.239022817153277, 16.314970357161926],
         [-16.23447379066402, 16.315629351668356],
         [-16.222285832900347, 16.312169605759735],
         [-16.21576270057613, 16.311757727174065],
         [-16.27318343116695, 16.291656999701033],
         [-16.275586690444293, 16.291492231119932],
         [-16.261151257770123, 16.28348554860811],
         [-16.263125363605084, 16.285380456302494],
         [-15.349532945468331, 16.531640286197554],
         [-15.342516286685372, 16.53303908675138],
         [-15.343760831668282, 16.534293884505125],
         [-15.341443403079415, 16.53347106722672],
         [-15.350734575107003, 16.529953483813124],
         [-15.352494104220773, 16.530426612798458],
         [-15.35530505926838, 16.53065289146851],
         [-15.347172601535226, 16.533656201420197],
         [-15.339705331637765, 16.53513726857499],
         [-15.372228274765694, 16.53250727135185],
         [-15.370640407028878, 16.532651265347788],
         [-15.367958198013985, 16.534523177519606],
         [-15.374416957321847, 16.534132340214054],
         [-15.368516097489083, 16.532342706653527],
         [-15.761818050079812, 16.317581828295985],
         [-15.76512253158616, 16.31914691574328],
         [-15.756668208771218, 16.316057915334337],
         [-15.756239055328836, 16.318611492498786],
         [-15.777010081940164, 16.31906454303178],
         [-15.774006007843484, 16.321041478537605],
         [-15.779155849152078, 16.31403974207035],
         [-15.776065944366922, 16.313174804301998],
         [-15.772804378204812, 16.31968233752282],
         [-15.768212436371316, 16.317664201631572],
         [-15.772418140106668, 16.324954104505824],
         [-15.784140135518136, 16.183276920629694],
         [-15.780835654011788, 16.181587105494266],
         [-16.371530857414943, 16.01942596171666],
         [-16.372539368004542, 16.020044693711473],
         [-16.37283977541421, 16.019281590641818],
         [-16.369149055809718, 16.019755952352632],
         [-16.37007173571084, 16.019755952352632],
         [-16.3705867198417, 16.02076654528073],
         [-16.371230450005275, 16.020890291001827],
         [-16.36829393202975, 16.0216770715846],
         [-16.366684606620815, 16.023388872769367],
         [-16.370654275962856, 16.023698232862262],
         [-16.368358305046108, 16.024007592475456],
         [-16.369366815635708, 16.023223880523656],
         [-16.29331670408466, 16.307411220690124],
         [-16.29005513792255, 16.311200555113025],
         [-16.325074058820988, 16.271820852300785],
         [-16.338019864499685, 15.966445713930485],
         [-16.336474912107107, 15.96430019299357],
         [-16.33415748351824, 15.965537996339247],
         [-16.330466763913748, 15.975192599830484],
         [-16.343305868781496, 15.974008850466653],
         [-16.34244756189673, 15.971368305794215],
         [-16.349142355597902, 15.972028445227789],
         [-16.34193257776587, 15.978629719819532],
         [-16.346567434943605, 15.979454863833018],
         [-16.357982916510988, 15.962621252822897],
         [-16.35918454614966, 15.95890776576452]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// -----------------------------------------------------------------
// Classifying Sentinel-2 data
// Contact: izvonkov@umd.edu
// -----------------------------------------------------------------

// 1. Specifying the ROI
var regionFilter = "ADM0_NAME == 'Senegal' && ADM1_NAME == 'Saint louis'"
var roi = ee.FeatureCollection("FAO/GAUL/2015/level1").filter(regionFilter);
Map.centerObject(roi, 7);

// 2. Load S2 images with Cloud Score Plus
function clipFunc(img){return img.clip(roi)}
function cloudScorePlus(img){return img.updateMask(img.select('cs_cdf').gte(0.7))}
function computeNDVI(img){
  var ndvi = img.normalizedDifference(['B8', 'B4']).rename('NDVI')
  return img.addBands(ndvi)
}

var start = ee.Date("2022-04-01")
var end = ee.Date("2023-01-01")

var csPlus = ee.ImageCollection('GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED');
var S2 = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
  .filterDate(start, end)
  .filterBounds(roi)
  .linkCollection(csPlus, ['cs_cdf'])
  .map(cloudScorePlus)
  .map(clipFunc)
  .map(computeNDVI)
  // TODO 1: Add additional bands: B5, B6, B7, B8, B8A, B11, B12 to the EO data
  .select(['B2', 'B3', 'B4', 'NDVI'])
  
var numMonths = end.difference(start, 'month').toInt().getInfo()
print("Number of EO months: " + numMonths)
var vis = { bands: ['B4', 'B3', 'B2'], min: 0, max: 2500 }
var images = []
for (var i=0; i<numMonths; i++){
  var monthStart = start.advance(i, 'month')
  var monthEnd = monthStart.advance(1, 'month')
  var S2MedianComposite = S2.filterDate(monthStart, monthEnd).median()
  var layerName = "S2 " + monthStart.format("YY/MM").getInfo()
  Map.addLayer(S2MedianComposite, vis, layerName, false)
  images.push(S2MedianComposite)
}

// 3. Load training labels
// TODO 2: Add the path to the training points you collected previously
var cropPts = ee.FeatureCollection("<YOUR CODE HERE>")
var nonCropPts = ee.FeatureCollection("<YOUR CODE HERE>") 

function toFC(points, is_crop){
  return ee.FeatureCollection(points.coordinates().map(function(p){
    return ee.Feature(ee.Geometry.Point(p), {"is_crop": is_crop})
  }))
}
var cropPts2 = toFC(cropPoints2, 1.0)
var nonCropPts2 = toFC(nonCropPoints2, 0.0)

// TODO 3: Merge the additional crop/non-crop points into the trainingPts dataset
var trainingPts = cropPts.merge(nonCropPts)
print("Training Non-crop points: " + trainingPts.filter(ee.Filter.eq("is_crop", 0)).size().getInfo())
print("Training Crop points: " + trainingPts.filter(ee.Filter.eq("is_crop", 1)).size().getInfo())

// 4. Combine training labels with Earth observation image sequence
var imageSequence = ee.ImageCollection.fromImages(images).toBands().unmask(0).clip(roi)
var bands = imageSequence.bandNames()
var training = imageSequence.sampleRegions({collection: trainingPts, properties: ["is_crop"], scale: 10 })

// 5. Train a classifier
var trainArgs = {features: training, classProperty: "is_crop",  inputProperties: bands}
var randomForest = ee.Classifier.smileRandomForest({numberOfTrees: 20}).setOutputMode("PROBABILITY")
var trainedRf = randomForest.train(trainArgs);

// 6. Use classifier to make predictions
var cropland = imageSequence.classify(trainedRf);
var classVis = {min: 0, max: 1.0, palette: ['yellow', 'green']}
Map.addLayer(cropland, classVis, 'Cropland Map');
Map.addLayer(cropland.gt(0.5), classVis, 'Cropland Map Binary');

// 7. Save the cropland map as an asset
// TODO 4: Add the maxPixels parameter with an appropriate value
Export.image.toAsset({
  image:  cropland, 
  description:  "Senegal_SL_cropland",
  scale: 10,
  crs: 'EPSG:31028'
})